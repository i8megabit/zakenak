# Инструмент управления Helm чартами

## Обзор
Инструмент управления чартами (charts.sh) - это комплексный скрипт для управления Helm чартами в кластере Kubernetes. Он обеспечивает функциональность установки, обновления, удаления и управления различными компонентами Kubernetes через Helm чарты.

## Основные возможности

### Управление чартами
- Установка/обновление/удаление отдельных или всех чартов
- Автоматическое разрешение зависимостей
- Управление пространствами имён
- Контроль версий
- Поддержка пользовательских файлов values

### Специальные обработчики
1. **Настройка GPU**
   - Автоматическая конфигурация GPU для чартов, которым это необходимо (ollama, open-webui)
   - Управление NVIDIA device plugin

2. **Управление сертификатами**
   - Автоматическая установка и настройка cert-manager
   - Управление CRD и их валидация
   - Обработка TLS сертификатов

3. **Управление Dashboard**
   - Установка Kubernetes Dashboard
   - Автоматическая настройка ServiceAccount и RBAC
   - Генерация токенов для аутентификации

4. **Управление DNS**
   - Конфигурация и управление CoreDNS
   - Тестирование разрешения DNS
   - Автоматический перезапуск подов

### Структура команд
```bash
./charts.sh [опции] <действие> <чарт>

Действия:
  install         - Установить чарт
  upgrade         - Обновить чарт
  uninstall       - Удалить чарт
  list           - Показать установленные чарты
  restart-dns    - Перезапустить CoreDNS
  dashboard-token - Получить токен доступа к dashboard
  reinstall-ingress - Переустановить ingress контроллер
  restart        - Перезапустить поды чарта

Опции:
  -n, --namespace <namespace> - Целевое пространство имён
  -v, --version <version>    - Версия чарта
  -f, --values <file>       - Файл values
```

## Ключевые функции

### Процесс установки чарта
1. **Предварительные проверки**
   - Валидация пространства имён
   - Очистка существующего релиза
   - Разрешение зависимостей

2. **Обработка специальных чартов**
   - cert-manager: управление CRD, настройка пространства имён
   - kubernetes-dashboard: настройка RBAC
   - local-ca: очистка сертификатов
   - Чарты с поддержкой GPU: настройка NVIDIA

3. **Валидация после установки**
   - Проверка конечных точек
   - Проверка готовности сервисов
   - Валидация ресурсов

### Обработка ошибок
- Комплексная проверка ошибок
- Подробное логирование ошибок
- Автоматические попытки восстановления
- Очистка ресурсов при сбое

### Мониторинг и статус
- Мониторинг статуса подов
- Проверка конечных точек сервисов
- Проверка работоспособности ресурсов
- Детальное логирование

## Лучшие практики
1. Всегда используйте флаги пространства имён для целевых операций
2. Проверяйте зависимости чартов перед установкой
3. Используйте контроль версий для воспроизводимых развёртываний
4. Следите за логами процесса установки
5. Используйте соответствующие тайм-ауты для операций с ресурсами

## Примеры использования

```bash
# Установка отдельного чарта
./charts.sh install ollama -n prod

# Обновление всех чартов
./charts.sh upgrade all

# Получение доступа к dashboard
./charts.sh token

# Перезапуск определённых сервисов
./charts.sh restart ollama -n prod
```

## Устранение неполадок
1. Проверьте статус подов после установки
2. Проверьте конечные точки сервисов
3. Просмотрите логи событий на наличие ошибок
4. Убедитесь в правильной настройке RBAC
5. Проверьте зависимости чартов

## Архитектура
Скрипт следует модульному дизайну и включает:
- Основные функции управления чартами
- Специализированные обработчики для конкретных чартов
- Служебные функции для общих операций
- Элементы баннера и пользовательского интерфейса
- Обработка ошибок и логирование